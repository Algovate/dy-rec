# Douyin Live Recorder

ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„æŠ–éŸ³ç›´æ’­å½•åˆ¶å·¥å…·ï¼Œæ”¯æŒ API å’Œæµè§ˆå™¨ä¸¤ç§æ¨¡å¼ï¼Œè‡ªåŠ¨é‡è¿ï¼Œå¤šæˆ¿é—´ç›‘æ§ç­‰åŠŸèƒ½ã€‚

## âœ¨ ç‰¹æ€§

- ğŸš€ **æ··åˆæ£€æµ‹æ¨¡å¼**: ä¼˜å…ˆä½¿ç”¨ API æ¨¡å¼ï¼ˆå¿«é€Ÿï¼‰ï¼Œå¤±è´¥æ—¶è‡ªåŠ¨å›é€€åˆ°æµè§ˆå™¨æ¨¡å¼ï¼ˆå¯é ï¼‰
- ğŸ“¹ **å¤šæ ¼å¼æ”¯æŒ**: æ”¯æŒ FLV å’Œ M3U8 (HLS) æµå½•åˆ¶
- ğŸ¬ **å¤šç§è¾“å‡ºæ ¼å¼**: æ”¯æŒ MP4ã€TSã€Fragmented MP4ï¼Œæ»¡è¶³è¾¹å½•è¾¹æ’­å’Œä¸­æ–­å®‰å…¨éœ€æ±‚
- ğŸ“¥ **çŸ­è§†é¢‘ä¸‹è½½**: æ”¯æŒä¸‹è½½æŠ–éŸ³çŸ­è§†é¢‘ï¼ˆæ”¯æŒçŸ­é“¾å’Œå®Œæ•´é“¾æ¥ï¼‰
- ğŸ”„ **è‡ªåŠ¨é‡è¿**: å½•åˆ¶ä¸­æ–­æ—¶è‡ªåŠ¨æ£€æµ‹å¹¶é‡è¿
- ğŸ‘€ **æˆ¿é—´ç›‘æ§**: è‡ªåŠ¨ç›‘æ§å¤šä¸ªç›´æ’­é—´ï¼Œå¼€æ’­æ—¶è‡ªåŠ¨å¼€å§‹å½•åˆ¶
- ğŸ“¦ **åˆ†æ®µå½•åˆ¶**: æ”¯æŒæŒ‰æ—¶é•¿åˆ†æ®µå½•åˆ¶ï¼Œé¿å…å•ä¸ªæ–‡ä»¶è¿‡å¤§
- ğŸ¯ **å¤šæˆ¿é—´å¹¶å‘**: æ”¯æŒåŒæ—¶å½•åˆ¶å¤šä¸ªç›´æ’­é—´
- âš™ï¸ **é…ç½®æ–‡ä»¶**: æ”¯æŒ JSON é…ç½®æ–‡ä»¶ç®¡ç†
- ğŸ”§ **TypeScript**: ä½¿ç”¨ TypeScript ç¼–å†™ï¼Œç±»å‹å®‰å…¨

## ğŸ“‹ è¦æ±‚

- Node.js 18+ 
- FFmpeg (éœ€è¦å®‰è£…å¹¶é…ç½®åˆ° PATH)
- npm æˆ– yarn

## ğŸš€ å®‰è£…

```bash
# å…‹éš†é¡¹ç›®
git clone <repository-url>
cd douyin-recorder

# å®‰è£…ä¾èµ–
npm install

# ç¼–è¯‘ TypeScript
npm run build
```

## ğŸ“– ä½¿ç”¨

### åŸºæœ¬ç”¨æ³•

```bash
# å½•åˆ¶å•ä¸ªç›´æ’­é—´ï¼ˆä½¿ç”¨ npm startï¼Œéœ€è¦ç”¨ -- åˆ†éš”å‚æ•°ï¼‰
npm start -- record -r 379595210124

# æˆ–ç›´æ¥è¿è¡Œç¼–è¯‘åçš„ä»£ç 
node dist/cli.js record -r 379595210124

# æˆ–ä½¿ç”¨å¼€å‘æ¨¡å¼ï¼ˆç›´æ¥è¿è¡Œ TypeScriptï¼Œæ— éœ€ç¼–è¯‘ï¼‰
npm run dev record -r 379595210124
```

### å‘½ä»¤é€‰é¡¹

#### `record` - å•æˆ¿é—´å½•åˆ¶

```bash
# ä½¿ç”¨ npm startï¼ˆéœ€è¦ç”¨ -- åˆ†éš”å‚æ•°ï¼‰
npm start -- record -r <roomId> [options]

# æˆ–ç›´æ¥è¿è¡Œ
node dist/cli.js record -r <roomId> [options]

é€‰é¡¹:
  -r, --room <roomId>        æŠ–éŸ³ç›´æ’­é—´ ID æˆ– URL
  -o, --output <dir>         è¾“å‡ºç›®å½• (é»˜è®¤: ./downloads)
  -m, --mode <mode>          æ£€æµ‹æ¨¡å¼: api, browser, hybrid (é»˜è®¤: hybrid)
                              - hybrid: API ä¼˜å…ˆï¼Œå¤±è´¥æ—¶è‡ªåŠ¨å›é€€åˆ°æµè§ˆå™¨æ¨¡å¼ï¼ˆæ¨èï¼‰
                              - api: ä»…ä½¿ç”¨ API æ¨¡å¼ï¼ˆå¯èƒ½éœ€è¦ Cookieï¼‰
                              - browser: ä»…ä½¿ç”¨æµè§ˆå™¨æ¨¡å¼ï¼ˆè¾ƒæ…¢ä½†å¯é ï¼‰
  -q, --quality <quality>    ç”»è´¨: origin, uhd, hd, sd, ld (é»˜è®¤: origin)
  --format <format>          è¾“å‡ºæ ¼å¼: mp4, ts, fmp4 (é»˜è®¤: fmp4)
                              - fmp4: Fragmented MP4ï¼Œæ”¯æŒè¾¹å½•è¾¹æ’­ï¼Œä¸­æ–­å®‰å…¨ï¼ˆæ¨èï¼‰
                              - ts: MPEG-TS æ ¼å¼ï¼Œæ”¯æŒè¾¹å½•è¾¹æ’­ï¼Œä¸­æ–­å®‰å…¨
                              - mp4: æ ‡å‡† MP4 æ ¼å¼ï¼Œå…¼å®¹æ€§æœ€å¥½ï¼Œä½†ä¸­æ–­ä¼šä¸¢å¤±æ•°æ®
  --video-only               ä»…å½•åˆ¶è§†é¢‘
  --audio-only               ä»…å½•åˆ¶éŸ³é¢‘
  -d, --duration <seconds>   å½•åˆ¶æ—¶é•¿ï¼ˆç§’ï¼‰ï¼Œä¸æŒ‡å®šåˆ™æŒç»­å½•åˆ¶
  --segment                  å¯ç”¨åˆ†æ®µå½•åˆ¶
  --segment-duration <sec>   åˆ†æ®µæ—¶é•¿ï¼ˆç§’ï¼‰
  --cookies <cookies>        API æ¨¡å¼éœ€è¦çš„ Cookie
```

#### `config` - é…ç½®æ–‡ä»¶æ¨¡å¼

```bash
# ä½¿ç”¨ npm startï¼ˆéœ€è¦ç”¨ -- åˆ†éš”å‚æ•°ï¼‰
npm start -- config [options]

# æˆ–ç›´æ¥è¿è¡Œ
node dist/cli.js config [options]

é€‰é¡¹:
  -f, --file <path>   é…ç½®æ–‡ä»¶è·¯å¾„ (é»˜è®¤: config/config.json)
  --watch             å¯ç”¨ç›‘å¬æ¨¡å¼
```

#### `watch` - ç›‘å¬æ¨¡å¼

```bash
# ä½¿ç”¨ npm startï¼ˆéœ€è¦ç”¨ -- åˆ†éš”å‚æ•°ï¼‰
npm start -- watch [options]

# æˆ–ç›´æ¥è¿è¡Œ
node dist/cli.js watch [options]

é€‰é¡¹:
  -f, --file <path>       é…ç½®æ–‡ä»¶è·¯å¾„ (é»˜è®¤: config/config.json)
  -i, --interval <sec>    æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰
```

#### `download` - çŸ­è§†é¢‘ä¸‹è½½

```bash
# ä½¿ç”¨ npm startï¼ˆéœ€è¦ç”¨ -- åˆ†éš”å‚æ•°ï¼‰
npm start -- download -u <url> [options]

# æˆ–ç›´æ¥è¿è¡Œ
node dist/cli.js download -u <url> [options]

é€‰é¡¹:
  -u, --url <url>         æŠ–éŸ³è§†é¢‘é“¾æ¥ï¼ˆå¿…å¡«ï¼Œæ”¯æŒçŸ­é“¾å’Œå®Œæ•´é“¾æ¥ï¼‰
  -o, --output <file>     è¾“å‡ºæ–‡ä»¶å
  --outdir <dir>          è¾“å‡ºç›®å½• (é»˜è®¤: ./recordings)
  --timeout <seconds>     è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰(é»˜è®¤: 30)
  --headful               æ˜¾ç¤ºæµè§ˆå™¨çª—å£ï¼ˆç”¨äºè°ƒè¯•ï¼‰
```

## âš™ï¸ é…ç½®æ–‡ä»¶

åˆ›å»º `config/config.json`:

```json
{
  "mode": "hybrid",
  "output": {
    "dir": "./downloads",
    "format": "mp4",
    "segmentDuration": 3600,
    "segmentEnabled": false
  },
  "recording": {
    "quality": "origin",
    "reconnect": true,
    "maxRetries": 3,
    "retryDelay": 5000
  },
  "watch": {
    "enabled": false,
    "interval": 60,
    "autoStart": true
  },
  "rooms": [
    {
      "url": "https://live.douyin.com/379595210124",
      "quality": "origin",
      "enabled": true
    }
  ],
  "api": {
    "cookies": "",
    "proxy": null
  },
  "browser": {
    "headless": true
  }
}
```

## ğŸ› ï¸ å¼€å‘

### é¡¹ç›®ç»“æ„

```
src/
â”œâ”€â”€ api/              # API å®¢æˆ·ç«¯
â”œâ”€â”€ config/           # é…ç½®ç®¡ç†
â”œâ”€â”€ download/         # çŸ­è§†é¢‘ä¸‹è½½æ¨¡å—
â”œâ”€â”€ monitor/          # ç›‘æ§æ¨¡å—
â”œâ”€â”€ recorders/        # å½•åˆ¶å™¨
â”œâ”€â”€ types/            # ç±»å‹å®šä¹‰
â”œâ”€â”€ browser.ts        # æµè§ˆå™¨æ§åˆ¶
â”œâ”€â”€ cli.ts            # CLI å…¥å£
â”œâ”€â”€ flvRecorder.ts    # FLV å½•åˆ¶å™¨
â”œâ”€â”€ streamDetector.ts # æµæ£€æµ‹å™¨
â”œâ”€â”€ taskManager.ts    # ä»»åŠ¡ç®¡ç†
â””â”€â”€ utils.ts          # å·¥å…·å‡½æ•°
```

### å¼€å‘å‘½ä»¤

```bash
# ç¼–è¯‘ TypeScript
npm run build

# å¼€å‘æ¨¡å¼ï¼ˆç›´æ¥è¿è¡Œ TSï¼Œæ— éœ€ç¼–è¯‘ï¼‰
npm run dev record -r 379595210124

# ä»£ç æ£€æŸ¥
npm run lint

# è‡ªåŠ¨ä¿®å¤ä»£ç é—®é¢˜
npm run lint:fix

# æ ¼å¼åŒ–ä»£ç 
npm run format

# æ£€æŸ¥ä»£ç æ ¼å¼
npm run format:check

# ç±»å‹æ£€æŸ¥ï¼ˆä¸ç”Ÿæˆæ–‡ä»¶ï¼‰
npm run type-check
```

### TypeScript é…ç½®

é¡¹ç›®ä½¿ç”¨ TypeScript ç¼–å†™ï¼Œé…ç½®æ–‡ä»¶ä¸º `tsconfig.json`ã€‚

**é‡è¦**: è¯·ä½¿ç”¨ `npm run build` æˆ– `tsc`ï¼ˆä¸å¸¦å‚æ•°ï¼‰æ¥ç¼–è¯‘é¡¹ç›®ï¼Œä¸è¦ç›´æ¥è¿è¡Œ `tsc src/cli.ts`ï¼Œå› ä¸ºé‚£æ ·ä¸ä¼šä½¿ç”¨ `tsconfig.json` é…ç½®ã€‚

## ğŸ“ ç¤ºä¾‹

### ç¤ºä¾‹ 1: å½•åˆ¶å•ä¸ªç›´æ’­é—´

```bash
# ä½¿ç”¨ npm start
npm start -- record -r 379595210124 -o ./videos

# æˆ–ç›´æ¥è¿è¡Œ
node dist/cli.js record -r 379595210124 -o ./videos
```

### ç¤ºä¾‹ 2: ä»…å½•åˆ¶éŸ³é¢‘

```bash
# ä½¿ç”¨ npm start
npm start -- record -r 379595210124 --audio-only -o ./audio

# æˆ–ç›´æ¥è¿è¡Œ
node dist/cli.js record -r 379595210124 --audio-only -o ./audio
```

### ç¤ºä¾‹ 3: ä½¿ç”¨ TS æ ¼å¼ï¼ˆè¾¹å½•è¾¹æ’­ï¼Œä¸­æ–­å®‰å…¨ï¼‰

```bash
# ä½¿ç”¨ TS æ ¼å¼ï¼Œæ”¯æŒå½•åˆ¶è¿‡ç¨‹ä¸­éšæ—¶æ‰“å¼€è§‚çœ‹ï¼Œä¸­æ–­ä¹Ÿä¸ä¼šä¸¢å¤±å·²å½•åˆ¶å†…å®¹
npm start -- record -r 379595210124 --format ts

# æˆ–ç›´æ¥è¿è¡Œ
node dist/cli.js record -r 379595210124 --format ts
```

### ç¤ºä¾‹ 4: ä½¿ç”¨ Fragmented MP4 æ ¼å¼

```bash
# ä½¿ç”¨ fMP4 æ ¼å¼ï¼Œæ”¯æŒè¾¹å½•è¾¹æ’­ï¼ŒMP4 å…¼å®¹æ€§å¥½
npm start -- record -r 379595210124 --format fmp4

# æˆ–ç›´æ¥è¿è¡Œ
node dist/cli.js record -r 379595210124 --format fmp4
```

### ç¤ºä¾‹ 5: åˆ†æ®µå½•åˆ¶ï¼ˆæ¯ 30 åˆ†é’Ÿä¸€æ®µï¼‰

```bash
# ä½¿ç”¨ npm start
npm start -- record -r 379595210124 --segment --segment-duration 1800

# æˆ–ç›´æ¥è¿è¡Œ
node dist/cli.js record -r 379595210124 --segment --segment-duration 1800
```

### ç¤ºä¾‹ 6: ä½¿ç”¨é…ç½®æ–‡ä»¶

```bash
# ç¼–è¾‘ config/config.json æ·»åŠ æˆ¿é—´åˆ—è¡¨
# ä½¿ç”¨ npm start
npm start -- config

# æˆ–ç›´æ¥è¿è¡Œ
node dist/cli.js config
```

### ç¤ºä¾‹ 7: ç›‘å¬æ¨¡å¼

```bash
# è‡ªåŠ¨ç›‘æ§é…ç½®ä¸­çš„æˆ¿é—´ï¼Œå¼€æ’­æ—¶è‡ªåŠ¨å½•åˆ¶
# ä½¿ç”¨ npm start
npm start -- watch

# æˆ–ç›´æ¥è¿è¡Œ
node dist/cli.js watch
```

### ç¤ºä¾‹ 8: ä¸‹è½½çŸ­è§†é¢‘

```bash
# ä¸‹è½½æŠ–éŸ³çŸ­è§†é¢‘ï¼ˆæ”¯æŒçŸ­é“¾ï¼‰
npm start -- download -u 'https://v.douyin.com/xxxxxx/'

# ä¸‹è½½æŠ–éŸ³çŸ­è§†é¢‘ï¼ˆå®Œæ•´é“¾æ¥ï¼‰
npm start -- download -u 'https://www.douyin.com/video/1234567890'

# æŒ‡å®šè¾“å‡ºæ–‡ä»¶å
npm start -- download -u 'https://v.douyin.com/xxxxxx/' -o my_video.mp4

# æŒ‡å®šè¾“å‡ºç›®å½•
npm start -- download -u 'https://v.douyin.com/xxxxxx/' --outdir downloads

# æ˜¾ç¤ºæµè§ˆå™¨çª—å£ï¼ˆè°ƒè¯•ç”¨ï¼‰
npm start -- download -u 'https://v.douyin.com/xxxxxx/' --headful
```

## ğŸ“º é•¿æ—¶é—´å½•åˆ¶å»ºè®®

é•¿æ—¶é—´ç›´æ’­å½•åˆ¶æ—¶ï¼Œæ¨èä»¥ä¸‹æ–¹æ¡ˆï¼š

### è¾“å‡ºæ ¼å¼å¯¹æ¯”

| æ ¼å¼ | è¾¹å½•è¾¹æ’­ | ä¸­æ–­å®‰å…¨ | å…¼å®¹æ€§ | æ¨èåœºæ™¯ |
|------|---------|---------|--------|---------|
| fmp4 (é»˜è®¤) | âœ… | âœ… | â­â­â­ | å¤§å¤šæ•°åœºæ™¯ï¼ˆæ¨èï¼‰ |
| ts | âœ… | âœ… | â­â­ | éœ€è¦æœ€å¤§ä¸­æ–­å®‰å…¨æ€§ |
| mp4 | âŒ | âŒ | â­â­â­ | çŸ­æ—¶é—´å½•åˆ¶ï¼Œè¿½æ±‚æœ€å¤§å…¼å®¹æ€§ |
| åˆ†æ®µå½•åˆ¶ | âœ… | âœ… | â­â­â­ | è¶…é•¿æ—¶é—´å½•åˆ¶ï¼ˆæ•°å°æ—¶ï¼‰ |

### æ¨èé…ç½®

**é•¿æ—¶é—´å½•åˆ¶ï¼ˆ1-2 å°æ—¶ï¼‰**ï¼š
```bash
# ä½¿ç”¨ TS æ ¼å¼æˆ– fMP4 æ ¼å¼
npm start -- record -r <roomId> --format ts
npm start -- record -r <roomId> --format fmp4
```

**è¶…é•¿æ—¶é—´å½•åˆ¶ï¼ˆæ•°å°æ—¶ï¼‰**ï¼š
```bash
# ä½¿ç”¨åˆ†æ®µå½•åˆ¶ï¼Œæ¯ 30 åˆ†é’Ÿè‡ªåŠ¨ä¿å­˜ä¸€ä¸ªæ–‡ä»¶
npm start -- record -r <roomId> --segment --segment-duration 1800
```

### æ ¼å¼è¯´æ˜

- **mp4**ï¼šæ ‡å‡† MP4 æ ¼å¼ï¼Œå½•åˆ¶å®Œæˆåæ‰èƒ½æ’­æ”¾ï¼Œä¸­æ–­ä¼šå¯¼è‡´æ–‡ä»¶æŸå
- **ts**ï¼šMPEG-TS æ ¼å¼ï¼Œå½•åˆ¶è¿‡ç¨‹ä¸­å¯éšæ—¶æ‰“å¼€æ’­æ”¾ï¼Œå³ä½¿ä¸­æ–­ä¹Ÿèƒ½ä¿ç•™å·²å½•åˆ¶éƒ¨åˆ†
- **fmp4**ï¼šFragmented MP4ï¼Œä¸ ts ç±»ä¼¼ä½†ä½¿ç”¨ MP4 å®¹å™¨ï¼Œå…¼å®¹æ€§æ›´å¥½
- **åˆ†æ®µå½•åˆ¶**ï¼šæŒ‰æ—¶é•¿è‡ªåŠ¨åˆ†å‰²æˆå¤šä¸ªæ–‡ä»¶ï¼Œæ¯æ®µéƒ½æ˜¯å®Œæ•´çš„ MP4

## ğŸ”§ æ•…éšœæ’é™¤

### npm start å‚æ•°é—®é¢˜

å¦‚æœä½¿ç”¨ `npm start` æ—¶é‡åˆ°å‚æ•°è§£æé—®é¢˜ï¼Œéœ€è¦ä½¿ç”¨ `--` åˆ†éš” npm å‚æ•°å’Œè„šæœ¬å‚æ•°ï¼š

```bash
# âŒ é”™è¯¯ï¼šnpm ä¼šæ‹¦æˆª -r å‚æ•°
npm start record -r 379595210124

# âœ… æ­£ç¡®ï¼šä½¿ç”¨ -- åˆ†éš”
npm start -- record -r 379595210124

# âœ… æˆ–è€…ç›´æ¥è¿è¡Œç¼–è¯‘åçš„ä»£ç 
node dist/cli.js record -r 379595210124
```

### FFmpeg æœªæ‰¾åˆ°

ç¡®ä¿ FFmpeg å·²å®‰è£…å¹¶é…ç½®åˆ° PATH:

```bash
ffmpeg -version
```

### ç¼–è¯‘é”™è¯¯

å¦‚æœé‡åˆ°ç¼–è¯‘é”™è¯¯ï¼Œç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„å‘½ä»¤ï¼š

```bash
# âœ… æ­£ç¡®ï¼šä½¿ç”¨ npm run build
npm run build

# âŒ é”™è¯¯ï¼šç›´æ¥è¿è¡Œ tsc src/cli.tsï¼ˆä¸ä¼šä½¿ç”¨ tsconfig.jsonï¼‰
tsc src/cli.ts
```

### API æ¨¡å¼å¤±è´¥

**æ¨èä½¿ç”¨ `hybrid` æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰**ï¼Œå®ƒä¼šè‡ªåŠ¨åœ¨ API æ¨¡å¼å¤±è´¥æ—¶å›é€€åˆ°æµè§ˆå™¨æ¨¡å¼ã€‚

å¦‚æœå¼ºåˆ¶ä½¿ç”¨ `-m api` æ¨¡å¼å¤±è´¥ï¼Œå¯èƒ½çš„åŸå› ï¼š

1. **éœ€è¦ Cookie**ï¼šæŠ–éŸ³ API å¯èƒ½æœ‰åçˆ¬è™«æœºåˆ¶ï¼Œéœ€è¦é…ç½® Cookie
   ```bash
   # åœ¨æµè§ˆå™¨ä¸­ç™»å½•æŠ–éŸ³ï¼Œå¤åˆ¶ Cookieï¼Œç„¶åä½¿ç”¨
   node dist/cli.js record -r 379595210124 -m api --cookies "your_cookie_here"
   ```

2. **API å·²æ›´æ–°**ï¼šæŠ–éŸ³å¯èƒ½æ›´æ–°äº† API æ ¼å¼ï¼Œæ­¤æ—¶åº”ä½¿ç”¨æµè§ˆå™¨æ¨¡å¼

3. **ç½‘ç»œé—®é¢˜**ï¼šæ£€æŸ¥ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™è®¾ç½®

**å»ºè®®**ï¼šä½¿ç”¨é»˜è®¤çš„ `hybrid` æ¨¡å¼ï¼Œæ— éœ€é¢å¤–é…ç½®å³å¯æ­£å¸¸å·¥ä½œ

### è¾“å‡ºè·¯å¾„é‡å¤é—®é¢˜

å¦‚æœé‡åˆ° `downloads/downloads/` è¿™æ ·çš„é‡å¤è·¯å¾„ï¼Œè¿™é€šå¸¸æ˜¯å› ä¸ºè·¯å¾„å¤„ç†é—®é¢˜ã€‚ç¡®ä¿ï¼š
1. é…ç½®æ–‡ä»¶ä¸­çš„ `output.dir` æ˜¯ç›¸å¯¹è·¯å¾„ï¼ˆå¦‚ `./downloads`ï¼‰
2. ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ä»£ç ï¼ˆå·²ä¿®å¤æ­¤é—®é¢˜ï¼‰

## ğŸ“„ è®¸å¯è¯

MIT

## ğŸ™ è‡´è°¢

- å‚è€ƒäº† [DouyinLiveRecorder](https://github.com/...) é¡¹ç›®çš„å®ç°æ€è·¯
